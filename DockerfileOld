FROM php:8.3-fpm

#Update Ubuntu software
RUN apt-get update && \
    apt-get -y install sudo

#Install nginx
RUN apt install -y nginx

#Install PHP extensions

RUN apt-get install wget -y \
    && apt-get install zlib1g-dev -y \
    && apt-get install procps -y \
    && apt-get install build-essential -y \
    && apt-get install zlib1g-dev -y \
    && apt-get install libcurl4-openssl-dev -y \
    && apt-get install bzip2 -y \
    && apt-get install libbz2-dev -y \
    && apt-get install libxml2-dev -y \
    && apt-get install libpng-dev -y \
    && apt-get install -y libmcrypt-dev \
    && apt-get install -y libzip-dev \
    && apt-get install -y libonig-dev \
    && apt-get install -y nano \
    && /usr/local/bin/docker-php-ext-install gd pdo pdo_mysql curl xml zip soap mbstring 

#install composer

RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin/ --filename=composer

#Install supervisor  and configure supervisor
RUN apt-get update && apt-get install -y supervisor
RUN mkdir -p /var/log/supervisor
RUN mkdir -p /var/log/php-fpm
COPY /container/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

#install node
RUN apt install -y curl
ENV NODE_VERSION=21.5.0
RUN curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.40.1/install.sh | bash
ENV NVM_DIR=/root/.nvm
RUN . "$NVM_DIR/nvm.sh" && nvm install ${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" && nvm use v${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" && nvm alias default v${NODE_VERSION}
ENV PATH="/root/.nvm/versions/node/v${NODE_VERSION}/bin/:${PATH}"


#install cron
RUN apt-get update && \
    apt-get install cron -y

#copy application

RUN mkdir /var/www/html/laravel
COPY . /var/www/html/laravel/.
RUN mv /var/www/html/laravel/.env /var/www/html/
RUN  cd /var/www/html/laravel && composer update

#Create docker user

RUN usermod -u 1000 www-data && groupmod -g 1000 www-data

#Change storage permission

RUN cd  /var/www/html/laravel/ && chown -R www-data:www-data storage/
RUN cd  /var/www/html/laravel/ && chown -R www-data:www-data public/

COPY /container/nginx.conf /etc/nginx/sites-available/default

#configure php.ini for production

COPY /container/php.ini /usr/local/etc/php/
COPY /container/www.conf /usr/local/etc/php-fpm.d/

#Add startup script

COPY /container/entrypoint.sh /var
RUN tr -d "\r" < /var/entrypoint.sh > /var/entrypoint.sh
RUN chmod +x /var/entrypoint.sh

COPY /container/cronjob.sh /var
RUN tr -d "\r" < /var/cronjob.sh > /var/scheduler.sh
RUN chmod +x /var/scheduler.sh
RUN touch /var/log/cron.log
RUN chmod 777 /var/log/cron.log

EXPOSE 443 80 2096

ENTRYPOINT ["sh", "/var/entrypoint.sh"]